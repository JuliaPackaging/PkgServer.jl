# Deployment configuration

Deployment of a new PkgServer is as easy as filling out a `.env` file and running `make`.  The `.env` file controls the customization of the PkgServer and associated containers.  The values that should be set are listed in `.env.example`, along with whether the value is required or not.  There are two separate `docker-compose.yml` configurations listed here; a non-SSL version, and an SSL version.  The non-SSL version just runs the pkg server directly on port `8000`, while the SSL version runs an `nginx` SSL terminator (hooked up with `letsencrypt`), then `proxy_pass`'es the decrypted traffic to a PkgServer instance running within a separate container.

To avoid needing to memorize arcane `docker compose` commands, a handy `Makefile` is provided to ease usage of `docker compose`.  Valid make verbs are `up`, `build`, `logs`, `down`, `destroy`, etc....  By default, the non-SSL version will be deployed, to build/deploy the SSL version, invoke `make` with the `USE_SSL=1` flag.

The deployment also includes a [`watchtower`](https://github.com/containrrr/watchtower) listener that polls Docker Hub for updated versions of the [`juliapackaging/pkgserver.jl`](https://hub.docker.com/r/juliapackaging/pkgserver.jl) image every 5 minutes.  When a new version is discovered, it is automatically pulled down.  This forms the basis of our automatic deployment pipeline; as a PR is merged within this repository, it will trigger a new build of the `pkgserver.jl` docker image, which then gets downloaded by any and all deployments within a matter of minutes.  In the event of catastrophic server failure (e.g. a bug slips past and the PkgServer cannot start) pushing a new version should robustly upgrade, as the `watchtower` image is separated from the `pkgserver` process.

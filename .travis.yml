language: julia
julia:
  # Keep in sync with the Dockerfile and pkg-update.yml
  - 1.5
notifications:
    email: false
services:
    - docker

env:
    - USE_DOCKER=0
    - USE_DOCKER=1

before_script:
    - cp deployment/.env.example deployment/.env
    - if [ ${USE_DOCKER} = 1 ]; then
        make -C deployment local_build;
        make -C deployment up;
        make -C deployment stop-watchtower;
        (make -C deployment logs &);
        export JULIA_PKG_SERVER="http://localhost:8000";
        export JULIA_PKG_SERVER_STORAGE_ROOT=$(pwd)/deployment/storage;
      fi

after_script:
    - if [ ${USE_DOCKER} = 1 ]; then
        make -C deployment destroy;
      fi
